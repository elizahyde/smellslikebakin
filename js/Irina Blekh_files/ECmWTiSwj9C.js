/*!CK:3083239958!*//*1394051900,178142495*/

if (self.CavalryLogger) { CavalryLogger.start_js(["Gb4SN"]); }

__d("PresenceIndicator",["Arbiter","AvailableListConstants","CSS","DOM","Event","JSLogger","Run","TooltipLink","copyProperties","tx"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(r,s,t,u,v){this._id=r;this._firstname=s;this._tooltip=u;this._showtooltip=v;this._image=j.scry(this._tooltip,'i')[0];this._previousAvail=null;this._jslog=l.create('presence_indicator');d(['ChatVisibility'],function(x){this._jslog.log('vis_init',x.isOnline());this._chatVisibility=x;this._updateVisibility();}.bind(this));this._subscriptions=[g.subscribe([h.ON_AVAILABILITY_CHANGED],this._updateAvailability.bind(this)),g.subscribe(['chat/visibility-changed'],this._updateVisibility.bind(this))];setTimeout(this._updateAvailability.bind(this),0);var w=null;if(t)w=k.listen(this._tooltip,'click',function(event){d(['AvailableList','ChatOpenTab'],function(x,y){if(this._previousAvail!=h.OFFLINE)y.openUserTab(this._id,this._getLogData());}.bind(this));}.bind(this));m.onLeave(function(){if(w)w.remove();while(this._subscriptions.length){var x=this._subscriptions.pop();x.unsubscribe();}}.bind(this));}o(q.prototype,{_getLogData:function(){var r=i.hasClass(document.documentElement,'sidebarMode');return {mode:r?'sidebar':'chatNub',source:'presence',typehead:false};},_updateAvailability:function(){d(['AvailableList','ChatConfig'],function(r,s){if(!r.isReady())return;var t=r.get(this._id);if(t===this._previousAvail)return;this._previousAvail=t;this._updateDOM(t);}.bind(this));},_updateDOM:function(r){var s,t;switch(r){case h.OFFLINE:case h.IDLE:break;case h.ACTIVE:s=p._("{name} is available to chat",{name:this._firstname});t='online';break;case h.MOBILE:s=p._("{name} is available on mobile",{name:this._firstname});t='mobile';break;default:throw new Error('Invalid availability');}if(!s){i.hide(this._tooltip);return;}if(this._showtooltip)n.setTooltipText(this._tooltip,s);i.setClass(this._image,t);i.show(this._tooltip);},_updateVisibility:function(){if(this._chatVisibility.isOnline()){i.show(this._tooltip);}else i.hide(this._tooltip);}});e.exports=q;});